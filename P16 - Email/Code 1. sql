BEGIN
    :P17_APP_ITEM_URL := 'http://' ||
    OWA_UTIL.get_cgi_env('HTTP_HOST') || APEX_UTIL.PREPARE_URL(
        p_url => 'f?p=' || :APP_ID ||
        ':16:'||:APP_SESSION||'::NO::P16_ORDER:&P17_ORDER_ID.',
        p_checksum_type => 'SESSION');
END;


Hello &P17_CUSTOMER_FULLNAME.,

We're getting your order ready to be shipped. We will notify you when it has been sent.
<a href="&P17_APP_ITEM_URL." target="_blank">View your order</a>
If you have any questions contact us at noreply@oracle.com

<html>
<body>
  <p>Hello &P17_CUSTOMER_FULLNAME.,</p><br>
  <p>We're getting your order ready to be shipped. We will notify you when it has been sent.</p><br>
  <p><a href="&P17_APP_ITEM_URL." target="_blank">View your order</a></p><br>
  <p>If you have any questions contact us at noreply@oracle.com</p><br>
</body>
</html>


UPDATE ORDERS
SET STAR_RATING = :P16_REVIEW,
    FEEDBACK = :P16_FEEDBACK
WHERE ORDER_ID = :P16_ORDER;



TO_DATE(TO_CHAR(order_datetime, 'MM/DD/YYYY'), 'MM/DD/YYYY') = 
SYSDATE - 1
AND EMAIL_FLAGGED = 'N'
AND STAR_RATING IS NULL

DECLARE
    l_url CLOB;
BEGIN
    FOR x IN
    (   SELECT
            c.full_name,
            c.email_address,
            o.order_id,
            TO_DATE(TO_CHAR(o.order_datetime, 'MM/DD/YYYY'),
                'MM/DD/YYYY') as order_datetime
        FROM customers c
        JOIN orders o ON c.customer_id = o.customer_id
        WHERE TO_DATE(TO_CHAR(o.order_datetime, 'MM/DD/YYYY'),
            'MM/DD/YYYY') = sysdate
        AND o.email_flagged = 'N'
    )
    loop
        l_url := 'http://' || OWA_UTIL.get_cgi_env('HTTP_HOST')
        || APEX_UTIL.PREPARE_URL(
            p_url => 'f?p=' || :APP_ID ||
            ':16:'||:APP_SESSION||'::NO::P16_ORDER:'||apex_json.stringify(
            x.order_id),
            p_checksum_type => 'SESSION');

        apex_mail.send (
            p_to                        => apex_json.stringify(x.email_address),
            p_template_static_id        => 'PRODUCT_REVIEW_REMINDER',
            p_placeholders              => '{' ||
                ' "CUSTOMER_FULLNAME":"'  || apex_json.stringify(
                x.full_name ) ||
                ', "RATE_URL":"'        || apex_json.stringify(
                apex_mail.get_instance_url || apex_page.get_url( 16 ) ) ||
            '"}');

        Update orders set email_flagged = 'Y' where order_id =
        x.order_id;
    end loop;
end;